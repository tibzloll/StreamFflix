<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlix Player</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* Custom scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #111827; } /* gray-900 */
      ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } /* gray-600 */
      ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */

      /* Basic player page styling */
      body { background-color: #111827; /* gray-900 */ }
      iframe { aspect-ratio: 16 / 9; }

      /* Loading Spinner */
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #e50914;
        width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; /* Centered */
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      #selector-loading .spinner, #episode-loading .spinner { display: inline-block; vertical-align: middle; margin-right: 8px;}


      /* Episode Selector Styles (Copied from previous modal) */
      #episode-selector { max-height: 70vh; overflow-y: auto; background-color: #1f2937; /* gray-800 */ padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;}
      .season-list, .episode-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
      .season-button, .episode-button {
        background-color: #374151; /* gray-700 */ color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; /* rounded-md */
        border: 1px solid transparent; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; font-size: 0.875rem; /* text-sm */
      }
      .season-button:hover, .episode-button:hover { background-color: #4b5563; /* gray-600 */ }
      .season-button.active { background-color: #dc2626; /* red-600 */ border-color: #f87171; /* red-400 */ font-weight: 600; }
      .episode-button { text-align: left; width: 100%; } /* Make episode buttons full width */
      .episode-number { font-weight: 600; margin-right: 0.5rem; }
      .episode-title { color: #d1d5db; /* gray-300 */ }
    </style>
     <script>
        // Configure Tailwind
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
        }
    </script>
</head>
<body class="bg-gray-900 text-white font-sans antialiased p-4 md:p-8">

    <div class="container mx-auto max-w-6xl">
        <div class="flex items-center justify-between mb-4">
            <a href="index.html" class="inline-flex items-center px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-md transition duration-150">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Back to Browse
            </a>
            <h1 id="player-page-title" class="text-xl md:text-2xl font-semibold text-gray-200 truncate text-right">Loading Player...</h1>
        </div>

        <div id="iframe-container" class="bg-black aspect-video rounded-lg overflow-hidden shadow-xl hidden mb-6">
            <iframe id="video-player" class="w-full h-full border-0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen referrerpolicy="origin" title="Video Player"></iframe>
        </div>

         <div id="episode-selector" class="hidden">
            <div id="selector-loading" class="text-center p-4 hidden"><div class="spinner"></div>Loading Details...</div>
            <div id="selector-error" class="text-center p-4 text-red-500 hidden"></div>
            <div id="selector-content">
                <h4 class="text-md font-semibold mb-2 text-gray-300">Seasons</h4>
                <div id="season-list" class="season-list">
                    </div>
                <h4 class="text-md font-semibold mt-4 mb-2 text-gray-300">Episodes</h4>
                <div id="episode-list-container">
                     <div id="episode-loading" class="text-center p-4 hidden"><div class="spinner"></div>Loading Episodes...</div>
                     <div id="episode-error" class="text-center p-4 text-red-500 hidden"></div>
                     <div id="episode-list" class="episode-list flex-col"> </div>
                </div>
            </div>
        </div>

        <div id="player-error" class="text-center p-8 text-red-400 text-lg hidden">
            Could not load the requested content. Please try again later or go back.
        </div>

    </div>

    <script>
        // --- START CONFIGURATION ---
        // IMPORTANT: Copy TMDB API key here as well
        const TMDB_API_KEY = '1caf3d8d7639732de72d054a395eba76';
        const EMBED_API_BASE_URL = 'https://multiembed.mov/'; // Standard player
        // const EMBED_API_BASE_URL = 'https://multiembed.mov/directstream.php'; // Optional: VIP player
        // --- END CONFIGURATION ---

        // --- Constants ---
        const TMDB_API_BASE_URL = 'https://api.themoviedb.org/3';

        // --- DOM Elements ---
        const playerPageTitle = document.getElementById('player-page-title');
        const iframeContainer = document.getElementById('iframe-container');
        const videoPlayer = document.getElementById('video-player');
        const episodeSelector = document.getElementById('episode-selector');
        const seasonListContainer = document.getElementById('season-list');
        const episodeListContainer = document.getElementById('episode-list');
        const episodeListParent = document.getElementById('episode-list-container');
        const selectorLoading = document.getElementById('selector-loading');
        const selectorError = document.getElementById('selector-error');
        const episodeLoading = document.getElementById('episode-loading');
        const episodeError = document.getElementById('episode-error');
        const selectorContent = document.getElementById('selector-content');
        const playerError = document.getElementById('player-error');

         // --- State ---
        let currentShowData = { id: null, idType: null, name: null }; // Store TV show details if applicable
        let currentSelectedSeason = null;

        // --- Helper Functions --- (checkApiKey, fetchTMDBData are needed here too)
        function checkApiKey() { if (!TMDB_API_KEY || TMDB_API_KEY === 'YOUR_TMDB_API_KEY_HERE') { console.warn('TMDB API Key is not set.'); return false; } return true; };
        async function fetchTMDBData(endpoint, params = {}) { if (!checkApiKey()) return null; const queryParams = new URLSearchParams({ api_key: TMDB_API_KEY, ...params }); const url = `${TMDB_API_BASE_URL}${endpoint}?${queryParams}`; console.log(`Fetching TMDB: ${url}`); try { const response = await fetch(url); if (!response.ok) { console.error(`TMDB API Error: ${response.status} ${response.statusText} for ${url}`); try { const errorData = await response.json(); console.error("TMDB Error Details:", errorData); } catch (e) { /* Ignore */ } throw new Error(`HTTP error! status: ${response.status}`); } return await response.json(); } catch (error) { console.error(`Failed to fetch TMDB data from ${url}:`, error); return null; } };


        /** Populates the season list in the selector */
        function populateSeasons(seasons) {
            seasonListContainer.innerHTML = ''; // Clear previous seasons
            seasons.forEach(season => {
                if (season.season_number === 0 && season.episode_count < 1) return; // Skip season 0 if empty

                const seasonButton = document.createElement('button');
                seasonButton.className = 'season-button';
                seasonButton.textContent = season.name || `Season ${season.season_number}`;
                seasonButton.dataset.seasonNumber = season.season_number;

                seasonButton.addEventListener('click', () => {
                    loadEpisodesForSeason(season.season_number);
                    // Highlight active season
                    if (currentSelectedSeason) {
                        currentSelectedSeason.classList.remove('active');
                    }
                    seasonButton.classList.add('active');
                    currentSelectedSeason = seasonButton;
                });
                seasonListContainer.appendChild(seasonButton);
            });
        }

        /** Fetches and populates episodes for a given season */
        async function loadEpisodesForSeason(seasonNumber) {
            if (!currentShowData.id) return;

            console.log(`Loading episodes for Season ${seasonNumber}`);
            episodeListContainer.innerHTML = ''; // Clear previous episodes
            episodeError.classList.add('hidden');
            episodeLoading.classList.remove('hidden'); // Show episode loading spinner

            const seasonDetails = await fetchTMDBData(`/tv/${currentShowData.id}/season/${seasonNumber}`);

            episodeLoading.classList.add('hidden'); // Hide spinner

            if (seasonDetails && seasonDetails.episodes) {
                 if (seasonDetails.episodes.length === 0) {
                     episodeListContainer.innerHTML = '<p class="text-gray-400 text-center">No episode data available for this season.</p>';
                     return;
                 }
                seasonDetails.episodes.forEach(episode => {
                    const episodeButton = document.createElement('button');
                    episodeButton.className = 'episode-button'; // Button styling
                    episodeButton.dataset.seasonNumber = seasonNumber;
                    episodeButton.dataset.episodeNumber = episode.episode_number;
                    // Display episode number and title
                    episodeButton.innerHTML = `
                        <span class="episode-number">E${episode.episode_number}</span>
                        <span class="episode-title">${episode.name || 'Episode Title'}</span>
                    `;

                    episodeButton.addEventListener('click', () => {
                        playSelectedEpisode(seasonNumber, episode.episode_number);
                    });
                    episodeListContainer.appendChild(episodeButton); // Append to the list container
                });
            } else {
                console.error(`Failed to load details for Season ${seasonNumber}`);
                episodeError.textContent = `Could not load episodes for Season ${seasonNumber}.`;
                episodeError.classList.remove('hidden');
            }
        }

        /** Plays the selected episode using SuperEmbed URL */
        function playSelectedEpisode(seasonNum, episodeNum) {
            if (!currentShowData.id || !currentShowData.idType) return; // Should always be 'tmdb'

            // Construct SuperEmbed Episode URL
            const embedUrl = `${EMBED_API_BASE_URL}?video_id=${currentShowData.id}&tmdb=1&s=${seasonNum}&e=${episodeNum}`;
            const title = `${currentShowData.name} - S${seasonNum} E${episodeNum}`;

            console.log(`Playing selected episode: ${title}, URL: ${embedUrl}`);
            loadVideo(embedUrl, title); // Load into iframe and switch view
        }

        /** Loads video into iframe and updates UI */
        function loadVideo(url, title) {
            if (!url) {
                console.error("Cannot load video: No URL provided.");
                showError("Could not load video.");
                return;
            }
            videoPlayer.src = url;
            playerPageTitle.textContent = title || 'Now Playing';
            episodeSelector.classList.add('hidden'); // Hide selector
            iframeContainer.classList.remove('hidden'); // Show iframe
            playerError.classList.add('hidden'); // Hide error message
        }

        /** Displays a general error message on the player page */
        function showError(message = "Could not load the requested content.") {
            iframeContainer.classList.add('hidden');
            episodeSelector.classList.add('hidden');
            playerError.textContent = message;
            playerError.classList.remove('hidden');
            playerPageTitle.textContent = "Error";
        }


        // --- On Page Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Player page loaded");
            const urlParams = new URLSearchParams(window.location.search);

            const embedUrl = urlParams.get('embedUrl');
            const title = urlParams.get('title');
            const type = urlParams.get('type');
            const id = urlParams.get('id');
            const idtype = urlParams.get('idtype'); // Should be 'tmdb' for TV

            if (embedUrl) {
                // Direct playback for movies or pre-selected episodes
                console.log("Loading direct embed URL:", embedUrl);
                loadVideo(embedUrl, title || 'Now Playing');

            } else if (type === 'tv' && id && idtype === 'tmdb') {
                // Load TV show details for episode selection
                console.log(`Loading TV Show selector for ID: ${id}`);
                currentShowData = { id: id, idType: idtype, name: 'TV Show' }; // Store basic info
                playerPageTitle.textContent = 'Loading TV Show...';
                episodeSelector.classList.remove('hidden'); // Show selector container
                selectorLoading.classList.remove('hidden'); // Show loading spinner
                selectorContent.classList.add('hidden'); // Hide content until loaded
                iframeContainer.classList.add('hidden'); // Ensure iframe is hidden

                const tvDetails = await fetchTMDBData(`/tv/${id}`);
                selectorLoading.classList.add('hidden'); // Hide loading spinner

                if (tvDetails && tvDetails.seasons) {
                    currentShowData.name = tvDetails.name || 'TV Show'; // Update name
                    playerPageTitle.textContent = `Select Episode: ${currentShowData.name}`;
                    selectorContent.classList.remove('hidden'); // Show content area
                    selectorError.classList.add('hidden'); // Hide error message
                    populateSeasons(tvDetails.seasons); // Populate season list

                    // Auto-select first season's episodes
                    const firstRealSeason = tvDetails.seasons.find(s => s.season_number > 0);
                    if (firstRealSeason) {
                        loadEpisodesForSeason(firstRealSeason.season_number);
                         // Auto-highlight first season button
                         const firstSeasonButton = seasonListContainer.querySelector(`[data-season-number="${firstRealSeason.season_number}"]`);
                         if (firstSeasonButton) {
                             firstSeasonButton.classList.add('active');
                             currentSelectedSeason = firstSeasonButton;
                         }
                    } else {
                        episodeListContainer.innerHTML = '<p class="text-gray-400 text-center">No regular seasons found.</p>';
                    }
                } else {
                    // Handle API error
                    console.error("Failed to load TV details for selector.");
                    showError('Could not load TV show details.');
                }

            } else {
                // Invalid parameters
                console.error("Invalid parameters received on player page.");
                showError("Invalid request. Please go back and try again.");
            }
        });

    </script>

</body>
</html>
